---
title: "test2019"
author: "zhenwei"
date: "2020/2/9"
output: html_document
---

```{r}
library(readxl)
library(lubridate)
library(tidyr)
library(dplyr)
library(hablar)
library(openxlsx)
library(expsmooth)
library(ggplot2)
library(forecast)
library(mapdata)

for (y in 1:3)
{
cov1=read_xlsx("time_series_2019-ncov.xlsx",sheet=1)
cov2=setNames(cov1, c('Province/State'
, format(as.Date(as.numeric(names(cov1)[-1]), 
                   origin = '1899-12-30'), '%m/%d/%Y')))

colnames(cov2)[2]="Country"
colnames(cov2)[3]="Lat"
colnames(cov2)[4]="Long"

e1=cov2[,-(1:4)]
e1=data.matrix(e1)
e1
a1=colnames(e1)
a1
t1=time(a1)
t1

for (i in 1:4)
{
b=e1[1,]
c=as.data.frame(colnames(e1))
c
b[is.na(b)]=0
b
e2=ts(b,start=c(2020,21), end = c(2020,56), frequency = 365.25)
e2
ets1=ets(e2)
# dum1=seasonaldummy(e2)
# dum1
ari1=auto.arima(e2)
ari1
arima(e2,order = c(0,2,1))
confint(ari1)
plot(ari1)
ets1
ti1=paste(cov1[i,1],sep=" ","Pneumonia")
ti1
f1=forecast(ets1)
plot(f1,main=ti1,xlab="Time",ylab="Amounts")
r1=residuals(ets1)
plot(r1,main=ti1,xlab="Time",ylab="Difference in perception and actual")
checkresiduals(r1)
plot(b)
c=mutate(c,Freq=b)


gg19=ggplot(c,aes(x=c,y=Freq))+geom_point(aes(x=c,y=Freq))+geom_smooth(method="lm")+theme(axis.text.x=element_text(angle=90,hjust=0.5))
ggplot(c,aes(x=c,y=Freq))+geom_col()+theme(axis.text.x=element_text(angle=90,hjust=0.5))
gg19+geom_forecast()
}
Loc=cov2$Country
Pla=cov2$`Province/State`
Pla
Map1=map("china", col = "red4", ylim = c(18, 56), panel.first=grid())
points(Pla,)
Las=cov2$`02/09/2020`
a=as.data.frame(Loc)
a=mutate(a,Pla,Las)
a[is.na(a)]="NA"
a
gg18=ggplot(a,aes(x=Pla,y=Las))+geom_col(aes(x=Pla,y=Las,color=Loc))+geom_smooth()+theme(axis.text.x=element_text(angle=90,hjust=0.5))+geom_text(aes(x=Pla,y=Las,label=Loc),size=1)
gg18
ggplot(a)+stat_summary(aes(x=Loc,y=Las))+theme(axis.text.x=element_text(angle=90,hjust=0.5))
ggplot(a)+geom_bar(aes(x=Pla),position="dodge")+theme(axis.text.x=element_text(angle=90,hjust=0.5))

autoplot(ets1)+ggtitle("Forecast the whole country")
}
```


